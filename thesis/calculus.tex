{

\def\msquare{\mathord{\scalerel*{\Box}{gX}}}

% effects
\newcommand\Eff[0]{E}
\newcommand\eff[0]{\varepsilon}
\newcommand\Op[0]{O}
\newcommand\op[0]{op}
\newcommand\inst[0]{\iota}

\newcommand\pty[1]{\ty^1_{#1}}
\newcommand\rty[1]{\ty^2_{#1}}

\newcommand\Loc[0]{L}
\newcommand\loc[0]{l}

% value types
\newcommand\ty[0]{\tau}
\newcommand\tunit[0]{()}
\newcommand\tinst[2]{\mathsf{Inst} \; #1 \; #2}
\newcommand\tarr[2]{#1 \rightarrow #2}
\newcommand\tforall[2]{\forall #1 . #2}
\newcommand\texists[2]{\exists #1 . #2}

% computation type
\newcommand\cty[0]{\underline{\ty}}
\newcommand\aty[2]{#1 \; ! \; #2}

% values
\newcommand\val[0]{\nu}
\newcommand\vunit[0]{()}
\newcommand\vinst[1]{\mathsf{inst}(#1)}
\newcommand\vabst[2]{\Lambda #1 . #2}
\newcommand\vabs[2]{\lambda #1 . #2}

% computations
\newcommand\comp[0]{c}
\newcommand\creturn[1]{\mathsf{return} \; #1}
\newcommand\capp[2]{#1 \; #2}
\newcommand\cappt[2]{#1 \; [ #2 ]}
\newcommand\cpack[2]{\mathsf{pack} \; #1 \; \mathsf{in} \; #2}
\newcommand\cunpack[4]{\mathsf{unpack} \; #1 \; \mathsf{as} \; ( #2, #3 ) ;\; #4}
\newcommand\cdo[3]{#1 \leftarrow #2 ;\; #3}
\newcommand\cop[3]{#1 \# #2(#3)}
\newcommand\cfresh[2]{\mathsf{fresh} \; #1 ;\; #2}
\newcommand\cnew[5]{\mathsf{new} \; #1 @ #2 \; \{ #3 \} \; \mathsf{as} \; #4 \;\mathsf{in}\; #5}
\newcommand\chandle[1]{\mathsf{handle} ( #1 )}
\newcommand\chandlec[2]{\mathsf{handle}^{#1} ( #2 )}
\newcommand\chandlei[3]{\mathsf{handle}^{#1} \{ #2 \} ( #3 )}

% handlers
\newcommand\handler[0]{h}
\newcommand\hop[5]{#1 \; #2 \; #3 \rightarrow #4 ; #5}
\newcommand\hreturn[2]{\mathsf{return} \; #1 \rightarrow #2}
\newcommand\hfinally[2]{\mathsf{finally} \; #1 \rightarrow #2}

% misc
\newcommand\subty[2]{#1 <: #2}
\newcommand\sep[0]{\;;\;}
\newcommand\sss[4]{#1 \; | \; #2 \rightsquigarrow #3 \; | \; #4}

% locations modelled by some countably infnite set.
% mathpartir
% explicit free variables fn FIV

% add substitution to type application
% more brackets in semantics

\section{Syntax}
We assume there is set of effect names $\Eff = \{ \eff_1, ..., \eff_n \}$.
Each effect has a set of operation names $\Op_\eff = \{ \op_1, ..., \op_n \}$.
Every operation name only corresponds to a single effect.
Each operation has a parameter type $\pty{\op}$ and a return type $\rty{\op}$.
We have scope variables $s$ modeled by some countable infinite set.
And we have locations $l$ modeled by some countable infinite set.
Annotations $r$ are sets of pairs of an effect name with a scope variable: $\{ \Eff_1@s_1, ..., \Eff_n@s_n \}$.
\\
\begin{figure}
\caption{Syntax}
\centering
\fbox{
\begin{minipage}{14 cm}
\begin{align*}
	s 	\Coloneqq		&																		\tag{scopes} \\
									& s_{var}														\tag{scope variable} \\
									& s_{loc}														\tag{scope location} \\
	\ty \Coloneqq 	& 																	\tag{value types} \\
									& \tinst{s}{\eff}										\tag{instance type} \\
									& \tarr{\ty}{\cty}									\tag{type of functions} \\
									& \tforall{s_{var}}{\cty}						\tag{universally quantified type over scope $s$}\\
	\cty \Coloneqq 	& 																	\tag{computation types} \\
									& \aty{\ty}{r}											\tag{annotated type} \\
	\val \Coloneqq	&																		\tag{values} \\
									& x, y, z, k												\tag{variables} \\
									& \vinst{s, \loc}										\tag{instance values (for semantics)} \\
									& \vabs{x}{\comp}										\tag{abstraction} \\
									& \vabst{s_{var}}{\comp}						\tag{scope abstraction} \\
	\comp \Coloneqq	&																		\tag{computations} \\
									& \creturn{\val}										\tag{return value as computation} \\
									& \capp{\val}{\val}									\tag{application} \\
									& \cappt{\val}{s}										\tag{scope application} \\
									& \cdo{x}{\comp}{\comp}							\tag{sequencing} \\
									& \cop{\val}{\op}{\val}							\tag{operation call} \\
									& \cnew{\eff}{s}{\handler ; \hfinally{x}{\comp}}{x}{\comp}		\tag{instance creation} \\
									& \chandle{\val}										\tag{handle scoped computation} \\
									& \chandlec{s_{loc}}{\comp}								\tag{handle computation (for semantics)} \\
									& \chandlei{\loc}{\handler}{\comp}	\tag{handle instance (for semantics)} \\
	\handler \Coloneqq 		&															\tag{handlers} \\
									& \hop{\op}{x}{k}{\comp}{\handler}	\tag{operation case} \\
									& \hreturn{x}{\comp}								\tag{return/finally case} \\
\end{align*}
\label{fig:syntax-calc}
\end{minipage}
}
\end{figure}

\section{Subtyping}
\begin{figure}
\caption{Subtyping}
\centering
\fbox{
\begin{minipage}{14 cm}
$$\inferrule{
}{
	\subty{ \tinst{s}{\eff} }{ \tinst{s}{\eff} } 
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\subty{\ty_2}{\ty_1} \\
	\subty{\cty_1}{\cty_2} \\
}{
	\subty{ \tarr{\ty_1}{\cty_1} }{ \tarr{\ty_2}{\cty_2} }
}
\hspace{3em}
\mprset{vskip=0 ex}
$$
$$
\inferrule{
	\subty{ \cty_1 }{ \cty_2 }
}{
	\subty{ \tforall{s_{var}}{\cty_1} }{ \tforall{s_{var}}{\cty_2} }
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\subty{ \ty_1 }{ \ty_2 } \\
	r_1 \subseteq r_2
}{
	\subty{ \aty{\ty_1}{r_1} }{ \aty{\ty_2}{r_2} }
}$$
\label{fig:subtyping-calc}
\end{minipage}
}
\end{figure}

\section{Well-formedness}
\begin{figure}
\caption{Well-formedness}
\centering
\fbox{
\begin{minipage}{14 cm}
$$\inferrule{
	s \in \Delta \lor s \in \Sigma \\
}{
	\Delta;\Sigma \vdash \tinst{s}{\eff}
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Delta;\Sigma \vdash \ty \\
	\Delta;\Sigma \vdash \cty \\
}{
	\Delta;\Sigma \vdash \tarr{\ty}{\cty}
}
\hspace{3em}
\mprset{vskip=0 ex}
$$
$$
\inferrule{
	\Delta,s;\Sigma \vdash \cty 
}{
	\Delta;\Sigma \vdash \tforall{s}{\cty}
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Delta;\Sigma \vdash \ty \\
	\forall (\eff@s \in r) \Rightarrow s \in \Delta \lor s \in \Sigma \\
}{
	\Delta;\Sigma \vdash \aty{\ty}{r}
}$$
\label{fig:wf-calc}
\end{minipage}
}
\end{figure}

\section{Typing rules}
\begin{figure}
\caption{Value typing rules}
\centering
\fbox{
\begin{minipage}{14 cm}
$$\inferrule{
	\Gamma[x] = \ty
}{
	\Delta;\Sigma;\Gamma \vdash x : \ty
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Sigma(\loc) = (s_{loc}, \eff)
}{
	\Delta;\Sigma;\Gamma \vdash \vinst{\loc} : \tinst{s_{loc}}{\eff}
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Delta;\Sigma;\Gamma, x : \ty \vdash \comp : \cty
}{
	\Delta;\Sigma;\Gamma \vdash \vabs{x}{\comp} : \tarr{\ty}{\cty}
}
$$
$$
\inferrule{
	\Delta,s_{var};\Sigma;\Gamma \vdash \comp : \cty
}{
	\Delta;\Sigma;\Gamma \vdash \vabst{s_{var}}{\comp} : \tforall{s_{var}}{\cty}
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val : \ty_1 \\
	\Delta;\Sigma \vdash \ty_2 \\
	\subty{\ty_1}{\ty_2}
}{
	\Delta;\Sigma;\Gamma \vdash \val : \ty_2
}
$$
\label{fig:val-typing-calc}
\end{minipage}
}
\end{figure}

\begin{figure}
\caption{Computation typing rules}
\centering
\fbox{
\begin{minipage}{14 cm}
$$\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val : \ty
}{
	\Delta;\Sigma;\Gamma \vdash \creturn{\val} : \aty{\ty}{\varnothing}
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val_1 : \tarr{\ty}{\cty} \\
	\Delta;\Sigma;\Gamma \vdash \val_2 : \ty \\
}{
	\Delta;\Sigma;\Gamma \vdash \capp{\val_1}{\val_2} : \cty
}
$$
$$
\inferrule{
	s \in \Delta \lor s \in \Sigma \\
	\Delta;\Sigma;\Gamma \vdash \val : \tforall{s'_{var}}{\cty}
}{
	\Delta;\Sigma;\Gamma \vdash \cappt{\val}{s} : \cty[s'_{var} := s]
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \comp_1 : \aty{\ty_1}{r} \\
	\Delta;\Sigma;\Gamma,x:\ty_1 \vdash \comp_2 : \aty{\ty_2}{r} \\
}{
	\Delta;\Sigma;\Gamma \vdash (\cdo{x}{\comp_1}{\comp_2}) : \aty{\ty_2}{r}
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val_1 : \tinst{s}{\eff} \\
	\op \in \Op_\eff \\
	\Delta;\Sigma;\Gamma \vdash \val_2 : \pty{\op} \\
}{
	\Delta;\Sigma;\Gamma \vdash \cop{\val_1}{\op}{\val_2} : \aty{\rty{\op}}{\{\eff@s\}}
}
$$
$$
\inferrule{
	s \in \Delta \lor s \in \Sigma \\
	\op \in \Op_\eff \iff \op \in \handler \\
	\Delta;\Sigma;\Gamma,x:\tinst{s}{\eff} \vdash \comp : \aty{\ty_1}{r} \\
	\Delta;\Sigma;\Gamma \vdash^{\ty_1} \handler : \aty{\ty_2}{r} \\
	\eff@s \in r \\
	\Delta;\Sigma;\Gamma,y : \ty_2 \vdash \comp' : \aty{\ty_3}{r} \\
}{
	\Delta;\Sigma;\Gamma \vdash \cnew{\eff}{s}{\handler; \hfinally{y}{\comp'}}{x}{\comp} : \aty{\ty_3}{r}
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val : \tforall{s_{var}}{\aty{\ty}{r}} \\
	s_{var} \notin \ty \\
	r' = \{ \eff@s' \;|\; \eff@s' \in r \wedge s' \neq s_{var} \}
}{
	\Delta;\Sigma;\Gamma \vdash \chandle{\val} : \aty{\ty}{r'}
}
$$
$$
\inferrule{
	s_{loc} \in \Sigma \\
	\Delta;\Sigma;\Gamma \vdash \comp : \aty{\ty}{r} \\
	s_{loc} \notin \ty \\
	r' = \{ \eff@s' \;|\; \eff@s' \in r \wedge s' \neq s_{loc} \}
}{
	\Delta;\Sigma;\Gamma \vdash \chandlec{s_{loc}}{\comp} : \aty{\ty}{r'}
}
$$
$$
\inferrule{
	\Sigma(\loc) = (s_{loc}, \eff) \\
	\op \in \Op_\eff \iff \op \in \handler \\
	\Delta;\Sigma;\Gamma \vdash^{\ty_1} \handler : \aty{\ty_2}{r} \\
	\Delta;\Sigma;\Gamma \vdash \comp : \aty{\ty_1}{r} \\
	\eff@s_{loc} \in r
}{
	\Delta;\Sigma;\Gamma \vdash \chandlei{\loc}{\handler}{\comp} : \aty{\ty_2}{r}
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \comp : \cty_1 \\
	\Delta;\Sigma \vdash \cty_2 \\
	\subty{\cty_1}{\cty_2}
}{
	\Delta;\Sigma;\Gamma \vdash \comp : \cty_2
}
$$
\label{fig:comp-typing-calc}
\end{minipage}
}
\end{figure}

\begin{figure}
\caption{Handler typing rules}
\centering
\fbox{
\begin{minipage}{14 cm}
$$
\inferrule{
	\Delta;\Sigma;\Gamma,x:\pty{\op},k:\tarr{\rty{\op}}{\aty{\ty_2}{r}} \vdash \comp : \aty{\ty_2}{r} \\
	\Delta;\Sigma;\Gamma \vdash^{\ty_1} \handler : \aty{\ty_2}{r} \\
}{
	\Delta;\Sigma;\Gamma \vdash^{\ty_1} (\hop{\op}{x}{k}{\comp}{\handler}) : \aty{\ty_2}{r}
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma,x : \ty_1 \vdash \comp : \aty{\ty_2}{r} \\
}{
	\Delta;\Sigma;\Gamma \vdash^{\ty_1} (\hreturn{x}{\comp}) : \aty{\ty_2}{r}
}
$$
\label{fig:handler-typing-calc}
\end{minipage}
}
\end{figure}

\section{Semantics}
\begin{figure}
\caption{Semantics}
\centering
\fbox{
\begin{minipage}{17 cm}
$$
\inferrule{
}{
	\capp{(\vabs{x}{\comp})}{\val} \;|\; \Sigma \rightsquigarrow \comp[x := \val] \;|\; \Sigma
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
}{
	\cappt{(\vabst{s}{\comp})}{s'} \;|\; \Sigma \rightsquigarrow \comp[s := s'] \;|\; \Sigma
}
$$
$$
\inferrule{
	\comp_1 ; \Sigma \rightsquigarrow \comp'_1 ; \Sigma'
}{
	(\cdo{x}{\comp_1}{\comp_2}) \;|\; \Sigma \rightsquigarrow (\cdo{x}{\comp'_1}{\comp_2}) \;|\; \Sigma'
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
}{
	(\cdo{x}{(\creturn{\val})}{\comp}) \;|\; \Sigma \rightsquigarrow \comp[x := \val] \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	(\cdo{y}{(\cdo{x}{\comp_1}{\comp_2})}{\comp_3} \;|\; \Sigma \rightsquigarrow
	(\cdo{x}{\comp_1}{\cdo{y}{\comp_2}{\comp_3}}) \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	(\cdo{x}{(\cnew{\eff}{s}{\handler ; \hfinally{z}{\comp_3}}{y}{\comp_1})}{\comp_2}) \;|\; \Sigma \rightsquigarrow \\
	 \cnew{\eff}{s}{\handler ; \hfinally{z}{\comp_3}}{y}{(\cdo{x}{\comp_1}{\comp_2})} \;|\; \Sigma
}
$$
$$
\inferrule{
	s_{loc} \notin \Sigma
}{
	\chandle{\vabst{s_{var}}{\comp}} \;|\; \Sigma \rightsquigarrow \chandlec{s_{loc}}{\comp[s_{var} := s_{loc}]} \;|\; \Sigma,s_{loc}
}
$$
\label{fig:semantics1-calc}
\end{minipage}
}
\end{figure}

\begin{figure}
\caption{Semantics of new handlers}
\centering
\fbox{
\begin{minipage}{17 cm}
$$
\inferrule{
	\comp \;|\; \Sigma \rightsquigarrow \comp' \;|\; \Sigma'
}{
	\chandlec{s_{loc}}{\comp} \;|\; \Sigma \rightsquigarrow \chandlec{s_{loc}}{\comp'} \;|\; \Sigma'
}
$$
$$
\inferrule{
}{
	\chandlec{s_{loc}}{\creturn{\val}} \;|\; \Sigma \rightsquigarrow
	\creturn{\val} \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	\chandlec{s_{loc}}{\cop{\val_1}{\op}{\val_2}} \;|\; \Sigma \rightsquigarrow
	\cop{\val_1}{\op}{\val_2} \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	\chandlec{s_{loc}}{\cdo{x}{\cop{\val_1}{\op}{\val_2}}{\comp}} \;|\; \Sigma \rightsquigarrow
	(\cdo{x}{\cop{\val_1}{\op}{\val_2}}{\chandlec{s_{loc}}{\comp}}) \;|\; \Sigma
}
$$
$$
\inferrule{
	s_{loc} \neq s'_{loc}
}{
	\chandlec{s_{loc}}{\cnew{\eff}{s'_{loc}}{\handler ; \hfinally{y}{\comp'}}{x}{\comp}} \;|\; \Sigma \rightsquigarrow \\
	\cnew{\eff}{s'_{loc}}{\handler ; \hfinally{y}{\comp'}}{x}{\chandlec{s_{loc}}{\comp}} \;|\; \Sigma
}
$$
$$
\inferrule{
	\loc \notin \mathsf{Dom}(\Sigma)
}{
	\chandlec{s_{loc}}{\cnew{\eff}{s_{loc}}{\handler; \hfinally{y}{\comp'}}{x}{\comp}} \;|\; \Sigma \rightsquigarrow \\
	\chandlec{s_{loc}}{\cdo{y}{\chandlei{\loc}{\handler}{\comp[x := \vinst{\loc}]}}{\comp'}} \;|\; \Sigma,\loc := (s_{loc}, \eff)
}
$$
\label{fig:semantics2-calc}
\end{minipage}
}
\end{figure}

\begin{figure}
\caption{Semantics of instance handlers}
\centering
\fbox{
\begin{minipage}{17 cm}
$$
\inferrule{
	\comp \;|\; \Sigma \rightsquigarrow \comp' \;|\; \Sigma'
}{
	\chandlei{\loc}{\handler}{\comp} \;|\; \Sigma \rightsquigarrow \chandlei{\loc}{\handler}{\comp'} \;|\; \Sigma'
}
$$
$$
\inferrule{
}{
	\chandlei{\loc}{\handler}{\cnew{\eff}{s}{\handler' ; \hfinally{y}{\comp'}}{x}{\comp}} \;|\; \Sigma \rightsquigarrow \\
	\cnew{\eff}{s}{\handler' ; \hfinally{y}{\comp'}}{x}{\chandlei{\loc}{\handler}{\comp}} \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	\chandlei{\loc}{\handler}{\cop{\val_1}{\op}{\val_2}} \;|\; \Sigma \rightsquigarrow
	\chandlei{\loc}{\handler}{\cdo{x}{\cop{\val_1}{\op}{\val_2}}{\creturn{x}}} \;|\; \Sigma
}
$$
$$
\inferrule{
	\loc \neq \loc'
}{
	\chandlei{\loc}{\handler}{\cdo{x}{\cop{\vinst{\loc'}}{\op}{\val}}{\comp}} \;|\; \Sigma \rightsquigarrow
	(\cdo{x}{\cop{\vinst{\loc'}}{\op}{\val}}{\chandlei{\loc}{\handler}{{\comp}}}) \;|\; \Sigma
}
$$
$$
\inferrule{
	\handler[\op] = (x, k, \comp_{\op})
}{
	\chandlei{\loc}{\handler}{\cdo{y}{\cop{\vinst{\loc}}{\op}{\val}}{\comp}} \;|\; \Sigma \rightsquigarrow 
	\comp_{\op}[x := \val, k := (\vabs{y}{\chandlei{\loc}{\handler}{\comp}})] \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	\chandlei{\loc}{\handler; \hreturn{x_r}{\comp_r}}{\creturn{\val}} \;|\; \Sigma \rightsquigarrow
	\comp_r[x_r := \val] \;|\; \Sigma
}
$$
\label{fig:semantics3-calc}
\end{minipage}
}
\end{figure}

\section{Evaluation Contexts}
\begin{figure}
\caption{Evaluation Contexts}
\centering
\fbox{
\begin{minipage}{14 cm}
\begin{align*}
	E \Coloneqq 			& 														\tag{computation contexts} \\
										& \msquare										\tag{hole} \\
										& \cdo{x}{E}{\comp}						\tag{sequencing} \\
										& \chandlec{s}{E}							\tag{computation handler} \\
										& \chandlei{\loc}{h}{E}				\tag{instance handler} \\
	H^s \Coloneqq 		& 														\tag{handler contexts} \\
										& \msquare										\tag{hole} \\
										& \cdo{x}{H^s}{\comp}					\tag{sequencing} \\
										& \chandlec{s'}{H^s} \hspace{30pt} (s \neq s') \tag{computation handler} \\
										& \chandlei{\loc}{h}{H^s}			\tag{instance handler} \\
	H^{\loc} \Coloneqq 		& 														\tag{instance handler contexts} \\
										& \msquare										\tag{hole} \\
										& \cdo{x}{H^{\loc}}{\comp}					\tag{sequencing} \\
										& \chandlec{s}{H^{\loc}} \tag{computation handler} \\
										& \chandlei{\loc'}{h}{H^{\loc}} \hspace{30pt} (\loc \neq \loc')			\tag{instance handler} \\
\end{align*}
\label{fig:evalcontext-calc}
\end{minipage}
}
\end{figure}

}