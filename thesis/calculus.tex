{
% effects
\newcommand\Eff[0]{E}
\newcommand\eff[0]{\varepsilon}
\newcommand\Op[0]{O}
\newcommand\op[0]{op}
\newcommand\inst[0]{\iota}

\newcommand\pty[1]{\ty^1_{#1}}
\newcommand\rty[1]{\ty^2_{#1}}

\newcommand\Loc[0]{L}
\newcommand\loc[0]{l}

% value types
\newcommand\ty[0]{\tau}
\newcommand\tunit[0]{()}
\newcommand\tinst[2]{\mathsf{Inst} \; #1 \; #2}
\newcommand\tarr[2]{#1 \rightarrow #2}
\newcommand\tforall[2]{\forall #1 . #2}
\newcommand\texists[2]{\exists #1 . #2}

% computation type
\newcommand\cty[0]{\underline{\ty}}
\newcommand\aty[2]{#1 \; ! \; #2}

% values
\newcommand\val[0]{\nu}
\newcommand\vunit[0]{()}
\newcommand\vinst[1]{\mathsf{inst}(#1)}
\newcommand\vabst[2]{\Lambda #1 . #2}
\newcommand\vabs[2]{\lambda #1 . #2}

% computations
\newcommand\comp[0]{c}
\newcommand\creturn[1]{\mathsf{return} \; #1}
\newcommand\capp[2]{#1 \; #2}
\newcommand\cappt[2]{#1 \; [ #2 ]}
\newcommand\cpack[2]{\mathsf{pack} \; #1 \; \mathsf{in} \; #2}
\newcommand\cunpack[4]{\mathsf{unpack} \; #1 \; \mathsf{as} \; ( #2, #3 ) ;\; #4}
\newcommand\cdo[3]{#1 \leftarrow #2 ;\; #3}
\newcommand\cop[3]{#1 \# #2(#3)}
\newcommand\cfresh[2]{\mathsf{fresh} \; #1 ;\; #2}
\newcommand\cnew[5]{\mathsf{new} \; #1 @ #2 \; \{ #3 \} \; \mathsf{as} \; #4 \;\mathsf{in}\; #5}
\newcommand\chandle[1]{\mathsf{handle} ( #1 )}
\newcommand\chandlec[2]{\mathsf{handle}^{#1} ( #2 )}
\newcommand\chandlei[3]{\mathsf{handle}^{#1} \{ #2 \} ( #3 )}

% handlers
\newcommand\handler[0]{h}
\newcommand\hop[5]{#1 \; #2 \; #3 \rightarrow #4 ; #5}
\newcommand\hreturn[4]{\mathsf{return} \; #1 \rightarrow #2 ; \mathsf{finally} \; #3 \rightarrow #4}

% misc
\newcommand\subty[2]{#1 <: #2}
\newcommand\sep[0]{\;;\;}
\newcommand\sss[4]{#1 \; | \; #2 \rightsquigarrow #3 \; | \; #4}

% locations modelled by some countably infnite set.
% mathpartir
% explicit free variables fn FIV

% add substitution to type application
% more brackets in semantics

\section{Syntax}
We assume there is set of effect names $\Eff = \{ \eff_1, ..., \eff_n \}$.
Each effect has a set of operation names $\Op_\eff = \{ \op_1, ..., \op_n \}$.
Every operation name only corresponds to a single effect.
Each operation has a parameter type $\pty{\op}$ and a return type $\rty{\op}$.
We have scope variables $s$ modeled by some countable infinite set.
And we have locations $l$ modeled by some countable infinite set.
Annotations $r$ are sets of pairs of an effect name with a scope variable: $\{ \Eff_1@s_1, ..., \Eff_n@s_n \}$.
\\
\begin{align*}
	\ty \Coloneqq 	& 																	\tag{value types} \\
									& \tinst{s}{\eff}										\tag{instance type} \\
									& \tarr{\ty}{\cty}									\tag{type of functions} \\
									& \tforall{s}{\cty}									\tag{universally quantified type over scope $s$}\\
	\cty \Coloneqq 	& 																	\tag{computation types} \\
									& \aty{\ty}{r}											\tag{annotated type} \\
	\val \Coloneqq	&																		\tag{values} \\
									& x, y, z, k												\tag{variables} \\
									& \vinst{\loc}											\tag{instance values (for semantics)} \\
									& \vabs{x}{\comp}										\tag{abstraction} \\
									& \vabst{s}{\comp}									\tag{scope abstraction} \\
	\comp \Coloneqq	&																		\tag{computations} \\
									& \creturn{\val}										\tag{return value as computation} \\
									& \capp{\val}{\val}									\tag{application} \\
									& \cappt{\val}{s}										\tag{scope application} \\
									& \cdo{x}{\comp}{\comp}							\tag{sequencing} \\
									& \cop{\val}{\op}{\val}							\tag{operation call} \\
									& \cnew{\eff}{s}{\handler}{x}{\comp}		\tag{instance creation} \\
									& \chandle{\val}										\tag{handle scoped computation} \\
									& \chandlec{s}{\comp}								\tag{handle computation (for semantics)} \\
									& \chandlei{\val}{\handler}{\comp}	\tag{handle instance (for semantics)} \\
	\handler \Coloneqq 		&															\tag{handlers} \\
									& \hop{\op}{x}{k}{\comp}{\handler}	\tag{operation case} \\
									& \hreturn{x}{\comp}{x}{\comp}			\tag{return/finally case} \\
\end{align*}

\section{Subtyping}
\begin{figure}
\caption{Subtyping}
\centering
\fbox{
\begin{minipage}{14 cm}
$$\inferrule{
}{
	\subty{ \tinst{s}{\eff} }{ \tinst{s}{\eff} } 
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\subty{\ty_2}{\ty_1} \\
	\subty{\cty_1}{\cty_2} \\
}{
	\subty{ \tarr{\ty_1}{\cty_1} }{ \tarr{\ty_2}{\cty_2} }
}
\hspace{3em}
\mprset{vskip=0 ex}
$$
$$
\inferrule{
	\subty{ \cty_1 }{ \cty_2 }
}{
	\subty{ \tforall{s}{\cty_1} }{ \tforall{s}{\cty_2} }
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\subty{ \ty_1 }{ \ty_2 } \\
	r_1 \subseteq r_2
}{
	\subty{ \aty{\ty_1}{r_1} }{ \aty{\ty_2}{r_2} }
}$$
\label{fig:subtyping-calc}
\end{minipage}
}
\end{figure}

\section{Well-formedness}
\begin{figure}
\caption{Well-formedness}
\centering
\fbox{
\begin{minipage}{14 cm}
$$\inferrule{
	s \in \Delta \\
}{
	\Delta \vdash \tinst{s}{\eff}
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Delta \vdash \ty \\
	\Delta \vdash \cty \\
}{
	\Delta \vdash \tarr{\ty}{\cty}
}
\hspace{3em}
\mprset{vskip=0 ex}
$$
$$
\inferrule{
	\Delta,s \vdash \cty 
}{
	\Delta \vdash \tforall{s}{\cty}
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Delta \vdash \ty \\
	\forall (\eff@s \in r) \Rightarrow s \in \Delta \\
}{
	\Delta \vdash \aty{\ty}{r}
}$$
\label{fig:wf-calc}
\end{minipage}
}
\end{figure}

\section{Typing rules}
\begin{figure}
\caption{Value typing rules}
\centering
\fbox{
\begin{minipage}{14 cm}
$$\inferrule{
	\Gamma[x] = \ty
}{
	\Delta;\Sigma;\Gamma \vdash x : \ty
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Sigma(\loc) = (s, \eff)
}{
	\Delta;\Sigma;\Gamma \vdash \vinst{\loc} : \tinst{s}{\eff}
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Delta;\Sigma;\Gamma, x : \ty \vdash \comp : \cty
}{
	\Delta;\Sigma;\Gamma \vdash \vabs{x}{\comp} : \tarr{\ty}{\cty}
}
$$
$$
\inferrule{
	\Delta,s;\Sigma;\Gamma \vdash \comp : \cty
}{
	\Delta;\Sigma;\Gamma \vdash \vabst{s}{\comp} : \tforall{s}{\cty}
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val : \ty_1 \\
	\Delta \vdash \ty_2 \\
	\subty{\ty_1}{\ty_2}
}{
	\Delta;\Sigma;\Gamma \vdash \val : \ty_2
}
$$
\label{fig:val-typing-calc}
\end{minipage}
}
\end{figure}

\begin{figure}
\caption{Computation typing rules}
\centering
\fbox{
\begin{minipage}{14 cm}
$$\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val : \ty
}{
	\Delta;\Sigma;\Gamma \vdash \creturn{\val} : \aty{\ty}{\varnothing}
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val_1 : \tarr{\ty}{\cty} \\
	\Delta;\Sigma;\Gamma \vdash \val_2 : \ty \\
}{
	\Delta;\Sigma;\Gamma \vdash \capp{\val_1}{\val_2} : \cty
}
$$
$$
\inferrule{
	s \in \Delta \\
	\Delta;\Sigma;\Gamma \vdash \val : \tforall{s'}{\cty}
}{
	\Delta;\Sigma;\Gamma \vdash \cappt{\val}{s} : \cty[s' := s]
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \comp_1 : \aty{\ty_1}{r} \\
	\Delta;\Sigma;\Gamma,x:\ty_1 \vdash \comp_2 : \aty{\ty_2}{r} \\
}{
	\Delta;\Sigma;\Gamma \vdash (\cdo{x}{\comp_1}{\comp_2}) : \aty{\ty_2}{r}
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val_1 : \tinst{s}{\eff} \\
	\op \in \Op_\eff \\
	\Delta;\Sigma;\Gamma \vdash \val_2 : \pty{\op} \\
}{
	\Delta;\Sigma;\Gamma \vdash \cop{\val_1}{\op}{\val_2} : \aty{\rty{\op}}{\{\eff@s\}}
}
$$
$$
\inferrule{
	s \in \Delta \\
	\op \in \Op_\eff \iff \op \in \handler \\
	\Delta;\Sigma;\Gamma \vdash^{(\ty_1, \aty{\ty_2}{r_2})} \handler : \aty{\ty_3}{r_3} \\
	\Delta;\Sigma;\Gamma,x:\tinst{s}{\eff} \vdash \comp : \aty{\ty_1}{r_1} \\
	(\eff@s \notin r_3) \land (r_1 \subseteq r_3)
}{
	\Delta;\Sigma;\Gamma \vdash \cnew{\eff}{s}{\handler}{x}{\comp} : \aty{\ty_3}{r_3}
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val : \tforall{s}{\cty} \\
	s \notin \cty
}{
	\Delta;\Sigma;\Gamma \vdash \chandle{\val} : \cty
}
$$
$$
\inferrule{
	s \in \Delta \\
	\Delta;\Sigma;\Gamma \vdash \val : \cty \\
	s \notin \cty
}{
	\Delta;\Sigma;\Gamma \vdash \chandlec{s}{\comp} : \cty
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \val : \tinst{s}{\eff} \\
	\op \in \Op_\eff \iff \op \in \handler \\
	\Delta;\Sigma;\Gamma \vdash^{(\ty_1, \aty{\ty_2}{r_2})} \handler : \aty{\ty_3}{r_3} \\
	\Delta;\Sigma;\Gamma \vdash \comp : \aty{\ty_1}{r_1} \\
	(\eff@s \notin r_3) \land (r_1 \subseteq r_3)
}{
	\Delta;\Sigma;\Gamma \vdash \chandlei{\val}{\handler}{\comp} : \aty{\ty_3}{r_3}
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma \vdash \comp : \cty_1 \\
	\Delta \vdash \cty_2 \\
	\subty{\cty_1}{\cty_2}
}{
	\Delta;\Sigma;\Gamma \vdash \comp : \cty_2
}
$$
\label{fig:comp-typing-calc}
\end{minipage}
}
\end{figure}

\begin{figure}
\caption{Handler typing rules}
\centering
\fbox{
\begin{minipage}{14 cm}
$$
\inferrule{
	\Delta;\Sigma;\Gamma,x:\pty{\op},k:\tarr{\rty{\op}}{\aty{\ty_2}{r_2}} \vdash \comp : \aty{\ty_2}{r_2} \\
	\Delta;\Sigma;\Gamma \vdash^{(\ty_1, \aty{\ty_2}{r_2})} \handler : \aty{\ty_3}{r_3} \\
}{
	\Delta;\Sigma;\Gamma \vdash^{(\ty_1, \aty{\ty_2}{r_2})} (\hop{\op}{x}{k}{\comp}{\handler}) : \aty{\ty_3}{r_3}
}
$$
$$
\inferrule{
	\Delta;\Sigma;\Gamma,x_r : \ty_1  \vdash \comp_r : \aty{\ty_2}{r_2} \\
	\Delta;\Sigma;\Gamma,x_f : \ty_2  \vdash \comp_f : \aty{\ty_3}{r_3} \\
}{
	\Delta;\Sigma;\Gamma \vdash^{(\ty_1, \aty{\ty_2}{r_2})} (\hreturn{x_r}{\comp_r}{x_f}{\comp_f}) : \aty{\ty_3}{r_3}
}
$$
\label{fig:handler-typing-calc}
\end{minipage}
}
\end{figure}

\section{Semantics}
\begin{figure}
\caption{Semantics}
\centering
\fbox{
\begin{minipage}{17 cm}
$$
\inferrule{
}{
	\capp{(\vabs{x}{\comp})}{\val} \;|\; \Sigma \rightsquigarrow \comp[x := \val] \;|\; \Sigma
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
}{
	\cappt{(\vabst{s}{\comp})}{s'} \;|\; \Sigma \rightsquigarrow \comp[s := s'] \;|\; \Sigma
}
$$
$$
\inferrule{
	\comp_1 ; \Sigma \rightsquigarrow \comp'_1 ; \Sigma'
}{
	(\cdo{x}{\comp_1}{\comp_2}) \;|\; \Sigma \rightsquigarrow (\cdo{x}{\comp'_1}{\comp_2}) \;|\; \Sigma'
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
}{
	(\cdo{x}{(\creturn{\val})}{\comp}) \;|\; \Sigma \rightsquigarrow \comp[x := \val] \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	(\cdo{y}{(\cdo{x}{\comp_1}{\comp_2})}{\comp_3} \;|\; \Sigma \rightsquigarrow
	(\cdo{x}{\comp_1}{\cdo{y}{\comp_2}{\comp_3}}) \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	(\cdo{x}{(\cnew{\eff}{s}{\handler}{y}{\comp_1})}{\comp_2}) \;|\; \Sigma \rightsquigarrow \cnew{\eff}{s}{\handler}{y}{(\cdo{x}{\comp_1}{\comp_2})} \;|\; \Sigma
}
$$
$$
\inferrule{
	\mathsf{fresh}\; s'
}{
	\chandle{\vabst{s}{\comp}} \;|\; \Sigma \rightsquigarrow \chandlec{s'}{\comp[s := s']} \;|\; \Sigma
}
\hspace{3em}
\mprset{vskip=0 ex}
\inferrule{
	\comp \;|\; \Sigma \rightsquigarrow \comp' \;|\; \Sigma'
}{
	\chandlec{s}{\comp} \;|\; \Sigma \rightsquigarrow \chandlec{s}{\comp'} \;|\; \Sigma'
}
$$
$$
\inferrule{
}{
	\chandlec{s}{\creturn{\val}} \;|\; \Sigma \rightsquigarrow
	\creturn{\val} \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	\chandlec{s}{\cop{\val_1}{\op}{\val_2}} \;|\; \Sigma \rightsquigarrow
	\chandlec{s}{\cdo{x}{\cop{\val_1}{\op}{\val_2}}{\creturn{x}}} \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	\chandlec{s}{\cdo{x}{\cop{\val_1}{\op}{\val_2}}{\comp}} \;|\; \Sigma \rightsquigarrow
	(\cdo{x}{\cop{\val_1}{\op}{\val_2}}{\chandlec{s}{\comp}}) \;|\; \Sigma
}
$$
$$
\inferrule{
	s \neq s'
}{
	\chandlec{s}{\cnew{\eff}{s'}{\handler}{x}{\comp}} \;|\; \Sigma \rightsquigarrow
	\cnew{\eff}{s'}{\handler}{x}{\chandlec{s}{\comp}} \;|\; \Sigma
}
$$
$$
\inferrule{
	\loc \notin \mathsf{Dom}(\Sigma)
}{
	\chandlec{s}{\cnew{\eff}{s}{\handler}{x}{\comp}} \;|\; \Sigma \rightsquigarrow \\
	\chandlei{\vinst{n}}{\handler}{\chandlec{s}{\comp[x := \vinst{\loc}]}} \;|\; \Sigma,\loc := (s, \eff)
}
$$
$$
\inferrule{
	\comp \;|\; \Sigma \rightsquigarrow \comp' \;|\; \Sigma'
}{
	\chandlei{\vinst{\loc}}{\handler}{\comp} \;|\; \Sigma \rightsquigarrow \chandlei{\vinst{\loc}}{\handler}{\comp'} \;|\; \Sigma'
}
$$
$$
\inferrule{
}{
	\chandlei{\vinst{\loc}}{\handler}{\cnew{\eff}{s}{\handler'}{x}{\comp}} \;|\; \Sigma \rightsquigarrow 
	\cnew{\eff}{s}{\handler'}{x}{\chandlei{\vinst{\loc}}{\handler}{\comp}} \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	\chandlei{\vinst{\loc}}{\handler}{\cop{\val_1}{\op}{\val_2}} \;|\; \Sigma \rightsquigarrow
	\chandlei{\vinst{\loc}}{\handler}{\cdo{x}{\cop{\val_1}{\op}{\val_2}}{\creturn{x}}} \;|\; \Sigma
}
$$
$$
\inferrule{
	\loc \neq \loc'
}{
	\chandlei{\vinst{\loc}}{\handler}{\cdo{x}{\cop{\vinst{\loc'}}{\op}{\val}}{\comp}} \;|\; \Sigma \rightsquigarrow
	(\cdo{x}{\cop{\vinst{\loc'}}{\op}{\val}}{\chandlei{\vinst{\loc}}{\handler}{{\comp}}}) \;|\; \Sigma
}
$$
$$
\inferrule{
	\handler[\op] = (x, k, \comp_{\op})
}{
	\chandlei{\vinst{\loc}}{\handler}{\cdo{x}{\cop{\vinst{\loc}}{\op}{\val}}{\comp}} \;|\; \Sigma \rightsquigarrow 
	\comp_{\op}[x := \val, k := (\vabs{x}{\chandlei{\vinst{\loc}}{\handler}{\comp}})] \;|\; \Sigma
}
$$
$$
\inferrule{
}{
	\chandlei{\vinst{\loc}}{\handler; \hreturn{x_r}{\comp_r}{x_f}{\comp_f}}{\creturn{\val}} \;|\; \Sigma \rightsquigarrow \\
	(\cdo{x}{\comp_r[x_r := \val]}{\comp_f[x_f := x]}) \;|\; \Sigma
}
$$
\label{fig:semantics-calc}
\end{minipage}
}
\end{figure}

}